# Data Insert/Update

## change_demo_wo_tran

### General Table Insert/Update Summary

| **Table Name** | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient        | Update            | Occurs for each active patient encounter found in the LIS system if certain internal patient demographic validation checks pass. The primary update changes demographic details based on data from the incoming cpi_transaction record (e.g., patient_name, dob, sex, medical_record_number, etc.). There are multiple update actions with varying conditions, especially for the Medical Record Number (MRN) and specific hospital system logic. |
| pat_amend_log  | Insert            | An audit record is inserted if any relevant demographic field (like name, Chinese name, date of birth, sex) has actually been modified as a result of the data from the incoming cpi_transaction record.                                                                                                                                                                                                                                          |
| pid_check      | Update            | Records in this table, used for patient identification checks, are updated if a relevant demographic field has been modified AND specifically if the patient's name (from cpi_transaction.patient_name), sex (from cpi_transaction.sex), or date of birth (from cpi_transaction.dob) has changed.                                                                                                                                                 |

---

### Detailed patient Table Column Insert/Update Analysis

The patient table in the LIS system is updated within a loop for each of the patient's active encounters. The new demographic values are primarily sourced from the corresponding fields in the incoming cpi_transaction record.

| **Column Name**    | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ------------------ | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_name           | Update            | Updated with the patient's name from the incoming cpi_transaction.patient_name.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| pat_cname          | Update            | Updated with the patient's Chinese name, derived from the incoming Chinese Commercial Code fields (cpi_transaction.ccc_1 to ccc_6) and/or the Chinese name field (cpi_transaction.chi_name).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| pat_dob            | Update            | Updated with the patient's date of birth from the incoming cpi_transaction.dob, if a date of birth is provided (not null) in the transaction; otherwise, it might be set to null in the patient table.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| pat_exact_dob_flag | Update            | Updated with an indicator from the incoming cpi_transaction.exact_dob_flag that specifies if the date of birth is exact.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| pat_sex            | Update            | Updated with the patient's sex from the incoming cpi_transaction.sex, if a sex value is provided (not null) in the transaction.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| pat_address        | Update            | Updated with the patient's address, constructed from incoming address components in the cpi_transaction record (like building, room, floor, block, district_code), unless the incoming cpi_transaction.transaction_type is "020" (which typically signifies a transaction type, such as merging patient identifiers, that doesn't update the address).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| pat_race           | Update            | Updated with the patient's race from the incoming cpi_transaction.race_code, unless the incoming cpi_transaction.transaction_type is "020".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| pat_mrn            | Update            | Updated with the patient's Medical Record Number from the incoming cpi_transaction.medical_record_number. <br/>This update is subject to several conditions: <br/> * An MRN must be provided (not null) in cpi_transaction.medical_record_number.<br/> * The incoming cpi_transaction.transaction_type must not be "040". <br/> * If the incoming cpi_transaction.source_system is "DNL", the MRN is only updated if the cpi_transaction.hospital_code (hospital of the current transaction) matches cpi_transaction.update_hospital.<br/> * Specific hospital system configurations (e.g., UCH-specific code) might have additional logic.<br/>This MRN update targets the patient record in the hospital specified by cpi_transaction.hospital_code (from the incoming transaction), which might differ from the hospital of the LIS patient record whose other demographics are being updated in the main update statement for the current loop iteration. |
| pat_bed            | Update            | For certain hospital systems (e.g., if UCH-specific code is compiled) and specifically for outpatient encounters (identified as "SOPD"), the bed information is updated if an MRN is provided in cpi_transaction.medical_record_number (and is not just spaces), and the currently stored bed information in the LIS patient table differs from new bed information derived based on this incoming MRN.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| pat_update_date    | Update            | Always updated with the LIS system's current transaction timestamp when the LIS patient record is modified.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| pat_update_by      | Update            | Always updated with the LIS system's user ID performing the update on the LIS patient record.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| pat_update_ws      | Update            | Always updated with the LIS system's workstation ID from which the update to the LIS patient record originated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| pat_ward_class     | Update            | Updated with the patient's ward class from the incoming cpi_transaction.ward_class, if a ward class is provided (not null) in that transaction.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

Important Considerations for patient table updates:

- The function processes each of the patient's active LIS encounters (found via get_all_active_enc()) one by one.
- The main demographic update correctly targets the specific LIS patient record for each encounter being processed in the loop. The ENCOUNTER, HOSPITAL, and PID for the WHERE clause of this update are populated from LIS internal arrays (ENCOUNTERS[i-1], HOSPITALS[i-1], PIDS[i-1]) that were filled based on the initial get_all_active_enc() call for the PID from the incoming cpi_transaction.hkid.
- As noted for pat_mrn, its update might target a LIS patient record in a hospital (specified by cpi_transaction.hospital_code from the incoming data) that is different from the HOSPITAL variable used in the main demographic update for that particular loop iteration (if cpi_transaction.hospital_code differs from HOSPITALS[i-1]).

---

## pmi_registration_wo_tran

### General Table Insert/Update Summary

| **Table Name** | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                               |
| -------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient        | Insert            | A new patient record is inserted if no existing "IPAS" type encounter is found for the patient ID (from cpi_transaction.hkid). This new record represents a PMI encounter.                                                                                                                |
| pat_amend_log  | Insert            | An audit record (with a transaction type indicating "Patient Admission," even for a PMI registration) is inserted if the system is in DEBUG_MODE. This is not a standard operational log entry for every PMI registration.                                                                |
| global_ctr     | Update            | Internal system counters are updated to generate new unique group identifiers for the patient (PID_GROUP), the new PMI encounter (ENCOUNTER_GROUP), and the PMI encounter number itself (ENCOUNTER_NO), if these don't already exist for the patient or a new encounter is being created. |

### Detailed patient Table Column Insert/Update Analysis (for new PMI record insertion)

| **Column Name**      | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -------------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter        | Insert            | Populated with a newly generated PMI encounter number. This is constructed by combining a prefix (from PMI_ENC_HEAD) with a unique sequence number (from ENCOUNTER_NO obtained via get_set_ctr). The length is padded to fit the pat_encounter column size.                                                                                                                                                                       |
| pat_pid              | Insert            | Populated with the patient identifier from the incoming cpi_transaction.hkid.                                                                                                                                                                                                                                                                                                                                                     |
| pat_name             | Insert            | Populated with the patient's name from the incoming cpi_transaction.patient_name.                                                                                                                                                                                                                                                                                                                                                 |
| pat_sex              | Insert            | Populated with the patient's sex from the incoming cpi_transaction.sex, if a value is provided in the transaction.                                                                                                                                                                                                                                                                                                                |
| pat_dob              | Insert            | Populated with the patient's date of birth from the incoming cpi_transaction.dob, if a date of birth is provided (not null) in the transaction.                                                                                                                                                                                                                                                                                   |
| pat_age              | Insert            | This column is not explicitly set by insert_pmi_patient_rec(). Its value would depend on database defaults or triggers if any, or it might remain null if the column allows it and no default is defined. The convert_IPAS_to_LIS and copy_patient_demo functions (called before insert_pmi_patient_rec) might calculate and set an age in a temporary structure, but the insert_pmi_patient_rec SQL itself doesn't list pat_age. |
| pat_age_unit         | Insert            | Similar to pat_age, this column is not explicitly set by the insert_pmi_patient_rec() SQL statement.                                                                                                                                                                                                                                                                                                                              |
| pat_att_dr           | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. It would be null or default based on table definition, as insert_pmi_patient_rec doesn't populate it.                                                                                                                                                                                                                                            |
| pat_adm_date         | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. The patient_adm_wo_tran function sets pat_adm_date from cpi_transaction.admission_datetime when calling insert_patient_rec, but insert_pmi_patient_rec (used here) does not include it in its INSERT list.                                                                                                                                       |
| pat_location         | Insert            | Populated with the location from the pat_location C variable. If the in_prog_id (passed to pmi_registration_wo_tran) indicates an IPAS_BATCH_ADM process, this variable would have been populated from cpi_transaction.ward_cde. Otherwise, it's typically empty for a standard PMI registration, unless convert_IPAS_to_LIS sets it based on other rules. The insert_pmi_patient_rec SQL does not explicitly list this column.   |
| pat_bed              | Insert            | Populated with the bed number from the pat_bed C variable. Similar to pat_location, this is populated from cpi_transaction.bed_no if it's an IPAS_BATCH_ADM process. For UCH "SOPD" encounters (if ENCOUNTER variable starts with "SOPD"), it might be derived from the MRN. Otherwise, it's typically empty. The insert_pmi_patient_rec SQL does not explicitly list this column.                                                |
| pat_unit             | Insert            | Populated with the unit from the pat_unit C variable. Similar to pat_location, this is populated from cpi_transaction.specialty_code if it's an IPAS_BATCH_ADM process. Otherwise, it's typically empty. The insert_pmi_patient_rec SQL does not explicitly list this column.                                                                                                                                                     |
| pat_cat              | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. The convert_IPAS_to_LIS or copy_patient_demo might set a pat_cat variable, but it's not in the INSERT list of insert_pmi_patient_rec.                                                                                                                                                                                                            |
| pat_risk             | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement.                                                                                                                                                                                                                                                                                                                                                  |
| pat_create_date      | Insert            | Populated with the LIS system's current transaction timestamp (obtained via set_action_info() and stored in pat_update_date C variable, which is then used for pat_create_date in the insert).                                                                                                                                                                                                                                    |
| pat_create_by        | Insert            | Populated with the LIS system user ID performing the creation (obtained via set_action_info() and stored in pat_update_by C variable, then used for pat_create_by).                                                                                                                                                                                                                                                               |
| pat_update_date      | Insert            | Populated with the LIS system's current transaction timestamp (obtained via set_action_info() and stored in pat_update_date C variable).                                                                                                                                                                                                                                                                                          |
| pat_update_by        | Insert            | Populated with the LIS system user ID performing the operation (obtained via set_action_info() and stored in pat_update_by C variable).                                                                                                                                                                                                                                                                                           |
| pat_create_ws        | Insert            | Populated with the LIS system workstation ID (obtained via set_action_info() and stored in pat_update_ws C variable, then used for pat_create_ws).                                                                                                                                                                                                                                                                                |
| pat_update_ws        | Insert            | Populated with the LIS system workstation ID (obtained via set_action_info() and stored in pat_update_ws C variable).                                                                                                                                                                                                                                                                                                             |
| pat_address          | Insert            | Populated with the patient's address from the incoming cpi_transaction.building, cpi_transaction.room etc., which are concatenated into cpi_addr[rec_no] (or a similar C variable pat_address after convert_IPAS_to_LIS/copy_patient_demo).                                                                                                                                                                                       |
| pat_discharge_date   | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. For a new PMI registration, this would typically be null.                                                                                                                                                                                                                                                                                        |
| pat_encounter_group  | Insert            | Populated with a newly generated unique identifier for this specific PMI encounter (obtained from get_set_ctr and stored in the ENCOUNTER_GROUP C variable).                                                                                                                                                                                                                                                                      |
| pat_pid_group        | Insert            | Populated with a patient group identifier (from the PID_GROUP C variable). This will be an existing group ID if the patient (based on cpi_transaction.hkid) already has one, or a newly generated one if this is the first record for this patient ID.                                                                                                                                                                            |
| pat_active_encounter | Insert            | Populated with the value of the ENCOUNTER_GROUP C variable. This seems to be a specific business rule where the active encounter marker is also the encounter group ID for new PMI records.                                                                                                                                                                                                                                       |
| pat_race             | Insert            | Populated with the patient's race from the incoming cpi_transaction.race_code.                                                                                                                                                                                                                                                                                                                                                    |
| pat_mrn              | Insert            | Populated with the patient's Medical Record Number from the incoming cpi_transaction.medical_record_number, if a value is provided in the transaction.                                                                                                                                                                                                                                                                            |
| pat_cname            | Insert            | Populated with the patient's Chinese name, derived from the incoming cpi_transaction.ccc_1 to ccc_6 (which are parts of cpi_patient_ccc[rec_no] C array after processing) and/or cpi_transaction.chi_name.                                                                                                                                                                                                                        |
| pat_death            | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. The set_patient_ind() function (called before insert_pmi_patient_rec) would set the pat_death C variable based on cpi_transaction.death_indicator. However, pat_death is not in the INSERT list of insert_pmi_patient_rec.                                                                                                                       |
| pat_confidential     | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. The set_patient_ind() function would set the pat_confidential C variable based on cpi_transaction.pmi_access_code. However, pat_confidential is not in the INSERT list of insert_pmi_patient_rec.                                                                                                                                                |
| pat_death_date       | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. The set_patient_ind() function would set the pat_death_date C variable based on cpi_transaction.death_date. However, pat_death_date is not in the INSERT list of insert_pmi_patient_rec.                                                                                                                                                         |
| pat_hospital         | Insert            | Populated with the hospital code from the incoming cpi_transaction.hospital_code.                                                                                                                                                                                                                                                                                                                                                 |
| pat_exact_dob_flag   | Insert            | Populated with an indicator from the incoming cpi_transaction.exact_dob_flag specifying if the date of birth is exact.                                                                                                                                                                                                                                                                                                            |
| pat_discharge_code   | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. For a new PMI registration, this would typically be null.                                                                                                                                                                                                                                                                                        |
| pat_type             | Insert            | This column is not explicitly set by the insert_pmi_patient_rec() SQL statement. The set_patient_ind() function would set the pat_type C variable based on cpi_transaction.patient_type. However, pat_type is not in the INSERT list of insert_pmi_patient_rec.                                                                                                                                                                   |
| pat_ward_class       | Insert            | Populated with the ward class from the incoming cpi_transaction.ward_class, if a value is provided in the transaction.                                                                                                                                                                                                                                                                                                            |

Key Points for pmi_registration_wo_tran:

- The primary purpose is to create a new base record (PMI encounter) for a patient if they are not already significantly registered (specifically, lacks an "IPAS" encounter).
- Many demographic details are taken directly from the cpi_transaction record.
- Location-specific details like pat_location, pat_unit, and pat_bed are more likely to be populated if the in_prog_id indicates a special type of admission process (like IPAS_BATCH_ADM) rather than a generic PMI creation.

---

## change_pid

This function handles the scenario where a patient's primary identifier (PID, often an HKID) needs to be changed. It first checks if the new PID already exists in the system.

- If the new PID exists, it means this is a merge operation, and the function diverts to merge_pid.
- If the new PID does not exist, this function proceeds to change the PID for all active encounters associated with the old PID. This involves "canceling" (deactivating and renaming the encounter) the old records and creating new ones with the new PID and a new PID_GROUP.

Here's the analysis assuming the new PID does not exist and the function proceeds with the PID change:

### General Table Insert/Update Summary

| **Table Name**                    | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                               |
| --------------------------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                           | Update            | For each active LIS patient encounter associated with the old patient identifier (from cpi_transaction.old_hkid), its existing record is updated to mark it as "canceled" (encounter name changed, active flag set to 0, PID group set to 0).                                                                                                             |
| patient                           | Insert            | For each "canceled" LIS patient encounter, a new patient record is inserted. This new record uses the new patient identifier (from cpi_transaction.hkid) and a newly generated PID_GROUP, while retaining most other details from the original LIS encounter.                                                                                             |
| pat_amend_log                     | Insert            | An audit record is inserted into pat_amend_log for each LIS patient encounter that has its PID changed.                                                                                                                                                                                                                                                   |
| pid_check                         | Update/Insert     | Records in the pid_check table are updated or inserted to reflect the PID change, linking the encounter group and the new PID group.                                                                                                                                                                                                                      |
| (System Counter Table)            | Update            | Internal system counters (likely in a table like global_ctr) are updated to generate a new unique Patient ID Group (PID_GROUP) for the new patient identifier (from cpi_transaction.hkid) if it's determined to be new to the system. A new unique Cancellation Number (CANCEL_NO) is also generated for each old LIS encounter that is being "canceled". |
| request (and related test tables) | Update            | For existing laboratory requests linked to the old Patient ID Group (SOURCE_PID_GROUP), their Patient ID Group (req_pid_group) is updated to the new PID_GROUP to ensure these requests remain associated with the correct patient demographic master after the PID change. This update is attempted with a retry mechanism.                              |

---

### Detailed patient Table Column Insert/Update Analysis

This section details the column-level changes for the two main operations on the LIS patient table for each LIS encounter being processed: first the UPDATE to "cancel" the old record, then the INSERT to create the new record with the new PID. The patient table schema you provided is referenced for column names.

Operation 1: UPDATE (Canceling the existing LIS patient record)

This update targets the LIS patient record identified by the original pat_encounter number, the pat_hospital of that LIS encounter, and the old pat_pid (which corresponds to cpi_transaction.old_hkid). This is performed by the cancel_patient_rec(0) call.

| **Column Name**       | **Insert/Update** | **Remarks**                                                                                                                                                                                     |
| --------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter         | Update            | The LIS pat_encounter identifier is changed to a new, unique "cancellation" encounter name (constructed using a standard prefix like CAN_ENC_HEAD and the newly generated CANCEL_NO).           |
| pat_pid_group         | Update            | The LIS pat_pid_group is set to 0, effectively disassociating this "canceled" version of the LIS encounter from any patient identifier group.                                                   |
| pat_active_encounter  | Update            | The LIS pat_active_encounter flag is set to 0, marking this version of the LIS encounter as inactive.                                                                                           |
| pat_update_date       | Update            | The LIS pat_update_date column is updated with the LIS system's current transaction timestamp at the moment this "cancellation" update occurred.                                                |
| pat_update_by         | Update            | The LIS pat_update_by column is updated with the LIS system user ID responsible for this "cancellation" update.                                                                                 |
| pat_update_ws         | Update            | The LIS pat_update_ws column is updated with the LIS system workstation from which this "cancellation" update was performed.                                                                    |
| Other patient columns | No Change         | The remaining columns in this "canceled" LIS patient record (e.g., pat_name, pat_dob, pat_location, etc.) are not modified by this specific UPDATE statement executed by cancel_patient_rec(0). |

Operation 2: INSERT (Creating a new LIS patient record with the new PID)

This inserts a new row into the LIS patient table. Values for this new record are primarily sourced from the details of the original LIS encounter (which were fetched into C variables by get_patient_details() using the old PID and original encounter number before the "cancel" update) and the new PID information from the incoming cpi_transaction record. This is performed by the insert_patient_rec(0) call.

| **Column Name**      | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                       |
| -------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter        | Insert            | The original LIS pat_encounter number (i.e., the value it had before being renamed in the "cancel" step; this original value is preserved in the C variable ENCOUNTER for the current loop iteration) is used for the new record.                                                                                                                                 |
| pat_pid              | Insert            | The new patient identifier from the incoming cpi_transaction.hkid is used for the LIS pat_pid column. This is the core of the "change PID" operation.                                                                                                                                                                                                             |
| pat_name             | Insert            | The patient's name (pat_name) from the original LIS encounter record (as fetched by get_patient_details()) is used.                                                                                                                                                                                                                                               |
| pat_sex              | Insert            | The patient's sex (pat_sex) from the original LIS encounter record is used.                                                                                                                                                                                                                                                                                       |
| pat_dob              | Insert            | The patient's date of birth (pat_dob), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                             |
| pat_age              | Insert            | The insert_patient_rec() SQL statement does not explicitly set this column. The value will depend on database defaults for pat_age or triggers, if any. The C variable pat_age (populated by get_patient_details()) is not part of the insert_patient_rec SQL's VALUES clause.                                                                                    |
| pat_age_unit         | Insert            | Similar to pat_age, this column is not explicitly set by the insert_patient_rec() SQL statement.                                                                                                                                                                                                                                                                  |
| pat_att_dr           | Insert            | The attending doctor (pat_att_dr) from the original LIS encounter record is used.                                                                                                                                                                                                                                                                                 |
| pat_adm_date         | Insert            | The admission date (pat_adm_date), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                                 |
| pat_location         | Insert            | The location (pat_location) from the original LIS encounter record is used. (The insert_patient_rec sub-function might add a hospital-specific prefix to this value before insertion, depending on the cpi_transaction.transaction_type and site configuration, which is a general behavior of insert_patient_rec and not specific to change_pid's direct logic). |
| pat_bed              | Insert            | The bed number (pat_bed) from the original LIS encounter record is used. (However, if UCH-specific code is compiled and the original encounter was an "SOPD" type, the pat_bed C variable might have been re-derived based on cpi_transaction.medical_record_number via convert_mrn_to_bed() before this insert, and that derived value would be used).           |
| pat_unit             | Insert            | The unit (pat_unit) from the original LIS encounter record is used. (A hospital-specific prefix might be added by insert_patient_rec, similar to pat_location).                                                                                                                                                                                                   |
| pat_cat              | Insert            | The patient category (pat_cat) is determined within the insert_patient_rec sub-function. This determination is typically based on the incoming cpi_transaction.case_type or the prefix of the original pat_encounter (e.g., "AE" or "HN" often map to inpatient category 1, while others generally map to outpatient category 2).                                 |
| pat_risk             | Insert            | The insert_patient_rec() SQL statement does not explicitly set this column. The C variable pat_risk (populated by get_patient_details()) is not part of its VALUES clause.                                                                                                                                                                                        |
| pat_create_date      | Insert            | The LIS pat_create_date column is populated with the LIS system's current transaction timestamp, recorded as the creation time for this new record.                                                                                                                                                                                                               |
| pat_create_by        | Insert            | The LIS pat_create_by column is populated with the LIS system user ID responsible for creating this new record.                                                                                                                                                                                                                                                   |
| pat_update_date      | Insert            | The LIS pat_update_date column is populated with the LIS system's current transaction timestamp (this also serves as the initial update time for the new record).                                                                                                                                                                                                 |
| pat_update_by        | Insert            | The LIS pat_update_by column is populated with the LIS system user ID (this also serves as the initial updating user for the new record).                                                                                                                                                                                                                         |
| pat_create_ws        | Insert            | The LIS pat_create_ws column is populated with the LIS system workstation ID from which this new record was created.                                                                                                                                                                                                                                              |
| pat_update_ws        | Insert            | The LIS pat_update_ws column is populated with the LIS system workstation ID (this also serves as the initial updating workstation for the new record).                                                                                                                                                                                                           |
| pat_address          | Insert            | The patient's address (pat_address), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                               |
| pat_discharge_date   | Insert            | The discharge date (pat_discharge_date), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                           |
| pat_encounter_group  | Insert            | The LIS pat_encounter_group identifier from the original LIS encounter record (stored in the C variable ENCOUNTER_GROUP) is used, maintaining this linkage for the encounter.                                                                                                                                                                                     |
| pat_pid_group        | Insert            | The new LIS pat_pid_group (stored in the C variable PID_GROUP), which was generated by get_set_ctr specifically for the new patient identifier (cpi_transaction.hkid), is used. This associates the newly created record with the new patient identifier group.                                                                                                   |
| pat_active_encounter | Insert            | The active encounter status (pat_active_encounter) from the original LIS encounter record is generally used (this is typically 1, unless the original encounter was already inactive for other reasons).                                                                                                                                                          |
| pat_race             | Insert            | The patient's race (pat_race) from the original LIS encounter record is used.                                                                                                                                                                                                                                                                                     |
| pat_mrn              | Insert            | The Medical Record Number (pat_mrn), along with its null indicator, from the original LIS encounter record is used. (The change_pid function previously had commented-out logic to potentially take this from cpi_transaction.medical_record_number; current active logic uses the value fetched from the original LIS record).                                   |
| pat_cname            | Insert            | The patient's Chinese name (pat_cname) from the original LIS encounter record is used.                                                                                                                                                                                                                                                                            |
| pat_death            | Insert            | The death indicator (pat_death), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                                   |
| pat_confidential     | Insert            | The confidentiality status (pat_confidential), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                     |
| pat_death_date       | Insert            | The date of death (pat_death_date), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                                |
| pat_hospital         | Insert            | The hospital code (pat_hospital) from the original LIS encounter record is used. (This is explicitly listed in the insert_patient_rec's VALUES clause, taking it from the pat_hospital C variable which was populated by get_patient_details from the original record).                                                                                           |
| pat_exact_dob_flag   | Insert            | The LIS pat_exact_dob_flag is populated with the value from the cpi_exact_dob_flag field of the current incoming cpi_transaction record (the transaction that initiated the PID change). This is used directly by the insert_patient_rec SQL statement.                                                                                                           |
| pat_discharge_code   | Insert            | The discharge code (pat_discharge_code), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                           |
| pat_type             | Insert            | The patient type (pat_type) from the original LIS encounter record (as fetched by get_patient_details() into the pat_type C variable) is used. The set_patient_ind() call, which would update this C variable from cpi_transaction.patient_type, is commented out in change_pid prior to this insert.                                                             |
| pat_ward_class       | Insert            | The ward class (pat_ward_class), along with its null indicator, from the original LIS encounter record is used.                                                                                                                                                                                                                                                   |

---

## patient_adm_wo_tran

This function handles patient admissions. It first checks if the given encounter (from cpi_transaction.case_no for a specific cpi_transaction.hospital_code) already exists.

- If the encounter exists and the patient ID (from cpi_transaction.hkid) matches the existing record, it's treated as an update to an existing admission (the registrated flag is set to 1).
- If the encounter exists but with a different patient ID, it's an error condition.
- If the encounter does not exist, it's a new admission.

The function then proceeds to either insert a new patient record or update an existing one, after ensuring/generating necessary PID_GROUP and ENCOUNTER_GROUP identifiers.

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Insert/Update     | If the encounter (from cpi_transaction.case_no for cpi_transaction.hospital_code) already exists for the same patient ID (from cpi_transaction.hkid), the existing LIS patient record is updated (this is indicated by the registrated flag being true when calling insert_patient_rec). Otherwise, a new LIS patient record is inserted.                                                                  |
| pat_amend_log          | Insert            | An audit record (with a transaction type PATIENT_ADM) is inserted into pat_amend_log if the system is in DEBUG_MODE and the insert/update to the patient table was successful. This is not a standard operational log for every admission.                                                                                                                                                                 |
| (System Counter Table) | Update            | Internal system counters (likely in a table like global_ctr) are updated via get_set_ctr to: <br/> 1. Generate a new Patient ID Group (PID_GROUP) if the patient ID (from cpi_transaction.hkid) does not already have one. <br/> 2. Generate a new Encounter Group (ENCOUNTER_GROUP) if the specific encounter (from cpi_transaction.case_no for cpi_transaction.hospital_code) does not already have one. |

---

### Detailed patient Table Column Insert/Update Analysis

The actual insert or update to the LIS patient table is performed by the insert_patient_rec(registrated) function call.

- If registrated is 0 (false), it performs an INSERT.
- If registrated is 1 (true), it performs an UPDATE.

The values for the columns are derived from the incoming cpi_transaction record (after processing by convert_IPAS_to_LIS and copy_patient_demo) and system-generated values.

Scenario 1: New Admission (INSERT operation, registrated == 0)

This occurs if the encounter from cpi_transaction.case_no for cpi_transaction.hospital_code does not exist, or if it exists but the patient ID in the existing record does not match cpi_transaction.hkid (though the latter case is handled as an error earlier and this path shouldn't be taken).

| **Column Name**      | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                       |
| -------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter        | Insert            | Populated with the encounter identifier from the incoming cpi_transaction.case_no.                                                                                                                                                                                                                                                                                                                |
| pat_pid              | Insert            | Populated with the patient identifier from the incoming cpi_transaction.hkid.                                                                                                                                                                                                                                                                                                                     |
| pat_name             | Insert            | Populated with the patient's name, derived from cpi_transaction.patient_name (after convert_IPAS_to_LIS, copy_patient_demo).                                                                                                                                                                                                                                                                      |
| pat_sex              | Insert            | Populated with the patient's sex from cpi_transaction.sex (after processing).                                                                                                                                                                                                                                                                                                                     |
| pat_dob              | Insert            | Populated with the patient's date of birth from cpi_transaction.dob (after processing), if provided.                                                                                                                                                                                                                                                                                              |
| pat_age              | Insert            | Not explicitly set by the insert_patient_rec() SQL. Value depends on database defaults or if convert_IPAS_to_LIS/copy_patient_demo populates the C variable pat_age which is then used by a different (unshown) insert logic, or if not part of the VALUES clause, it would be null/default. The insert_patient_rec in lis_sp_laps_sql.cp does not list pat_age in its VALUES list for an insert. |
| pat_age_unit         | Insert            | Similar to pat_age, not explicitly set by the insert_patient_rec() SQL.                                                                                                                                                                                                                                                                                                                           |
| pat_att_dr           | Insert            | Populated with the attending doctor, likely from cpi_transaction.doctor_code (after processing into C variable pat_att_dr).                                                                                                                                                                                                                                                                       |
| pat_adm_date         | Insert            | Populated with the admission datetime from cpi_transaction.admission_datetime (after processing into C variable pat_adm_date), if provided.                                                                                                                                                                                                                                                       |
| pat_location         | Insert            | Populated from cpi_transaction.ward_code if in_prog_id indicates IPAS_BATCH_ADM. Otherwise, derived by convert_IPAS_to_LIS/copy_patient_demo. A hospital prefix might be added by add_hospital_prefix() within insert_patient_rec based on conditions.                                                                                                                                            |
| pat_bed              | Insert            | Populated from cpi_transaction.bed_no if IPAS_BATCH_ADM. For UCH "SOPD" encounters, it might be derived from the MRN via convert_mrn_to_bed(). Otherwise, derived by convert_IPAS_to_LIS/copy_patient_demo.                                                                                                                                                                                       |
| pat_unit             | Insert            | Populated from cpi_transaction.specialty_code if IPAS_BATCH_ADM. Otherwise, derived by convert_IPAS_to_LIS/copy_patient_demo. A hospital prefix might be added.                                                                                                                                                                                                                                   |
| pat_cat              | Insert            | Patient category determined by insert_patient_rec typically based on cpi_transaction.case_type (e.g., 'A'/'I' for inpatient, 'O' for outpatient) or the prefix of pat_encounter (e.g., "AE", "HN" often imply inpatient).                                                                                                                                                                         |
| pat_risk             | Insert            | Not explicitly set by the insert_patient_rec() SQL.                                                                                                                                                                                                                                                                                                                                               |
| pat_create_date      | Insert            | Populated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                                                                                                                                                                                                                                           |
| pat_create_by        | Insert            | Populated with the LIS system user ID performing the creation (from set_action_info()).                                                                                                                                                                                                                                                                                                           |
| pat_update_date      | Insert            | Populated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                                                                                                                                                                                                                                           |
| pat_update_by        | Insert            | Populated with the LIS system user ID performing the operation (from set_action_info()).                                                                                                                                                                                                                                                                                                          |
| pat_create_ws        | Insert            | Populated with the LIS system workstation ID (from set_action_info()).                                                                                                                                                                                                                                                                                                                            |
| pat_update_ws        | Insert            | Populated with the LIS system workstation ID (from set_action_info()).                                                                                                                                                                                                                                                                                                                            |
| pat_address          | Insert            | Populated with the patient's address, constructed from cpi_transaction address fields (after processing), if provided.                                                                                                                                                                                                                                                                            |
| pat_discharge_date   | Insert            | Populated with the discharge datetime from cpi_transaction.discharge_datetime (after processing into C variable pat_discharge_date), if provided. Typically null for a new admission.                                                                                                                                                                                                             |
| pat_encounter_group  | Insert            | Populated with an Encounter Group ID. This will be an existing group ID if the encounter (from cpi_transaction.case_no for cpi_transaction.hospital_code) already has one, or a newly generated one via get_set_ctr if it's a new encounter for the system.                                                                                                                                       |
| pat_pid_group        | Insert            | Populated with a Patient ID Group. This will be an existing group ID if the patient ID (from cpi_transaction.hkid) already has one, or a newly generated one via get_set_ctr if it's a new patient ID for the system.                                                                                                                                                                             |
| pat_active_encounter | Insert            | Populated with an indicator that the encounter is active (typically the value of pat_encounter_group or a non-zero value like 1, set by set_patient_ind() and insert_patient_rec).                                                                                                                                                                                                                |
| pat_race             | Insert            | Populated with the patient's race from cpi_transaction.race_code (after processing).                                                                                                                                                                                                                                                                                                              |
| pat_mrn              | Insert            | Populated with the Medical Record Number from cpi_transaction.medical_record_number (after processing into C variable pat_mrn), if provided.                                                                                                                                                                                                                                                      |
| pat_cname            | Insert            | Populated with the patient's Chinese name, derived from cpi_transaction.ccc_1 to ccc_6 and/or cpi_transaction.chi_name (after processing).                                                                                                                                                                                                                                                        |
| pat_death            | Insert            | Populated based on cpi_transaction.death_indicator (after processing by set_patient_ind() into C variable pat_death), if provided.                                                                                                                                                                                                                                                                |
| pat_confidential     | Insert            | Populated based on cpi_transaction.pmi_access_code (after processing by set_patient_ind() into C variable pat_confidential), if provided.                                                                                                                                                                                                                                                         |
| pat_death_date       | Insert            | Populated with the date of death from cpi_transaction.death_date if cpi_transaction.death_indicator is 'Y' and a date is provided (after processing), if provided.                                                                                                                                                                                                                                |
| pat_hospital         | Insert            | Populated with the hospital code from the incoming cpi_transaction.hospital_code.                                                                                                                                                                                                                                                                                                                 |
| pat_exact_dob_flag   | Insert            | Populated with the exact DOB flag from cpi_transaction.exact_dob_flag.                                                                                                                                                                                                                                                                                                                            |
| pat_discharge_code   | Insert            | Populated with the discharge code from cpi_transaction.discharge_code (after processing into C variable pat_discharge_code), if provided. Typically null for a new admission.                                                                                                                                                                                                                     |
| pat_type             | Insert            | Populated with the patient type from cpi_transaction.patient_type (after processing by set_patient_ind() into C variable pat_type).                                                                                                                                                                                                                                                               |
| pat_ward_class       | Insert            | Populated with the ward class from cpi_transaction.ward_class (after processing by set_patient_ind() into C variable pat_ward_class), if provided.                                                                                                                                                                                                                                                |

Scenario 2: Existing Admission Update (UPDATE operation, registrated == 1)

This occurs if check_encounter() finds an existing LIS encounter for the cpi_transaction.case_no in cpi_transaction.hospital_code, and check_patient() confirms it belongs to the same cpi_transaction.hkid.

The insert_patient_rec(1) function will execute an UPDATE patient SET ... WHERE pat_encounter = :pat_encounter AND pat_hospital = :HOSPITAL AND pat_pid = :pat_pid;

The HOSPITAL in the WHERE clause for this update is the :HOSPITAL C variable, which was set from cpi_hospital_code[rec_no] at the beginning of patient_adm_wo_tran.

| **Column Name**      | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter        | Update            | Value remains the same (it's part of the WHERE clause and also in the SET clause, effectively re-setting to itself).                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_pid              | Update            | Value remains the same (part of WHERE and SET).                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| pat_name             | Update            | Updated with the patient's name from cpi_transaction.patient_name (after processing).                                                                                                                                                                                                                                                                                                                                                                                                                               |
| pat_sex              | Update            | Updated with the patient's sex from cpi_transaction.sex (after processing).                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| pat_dob              | Update            | Updated with the patient's date of birth from cpi_transaction.dob (after processing), if provided.                                                                                                                                                                                                                                                                                                                                                                                                                  |
| pat_age              | No Change         | Not part of the SET clause in insert_patient_rec's update statement.                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_age_unit         | No Change         | Not part of the SET clause.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| pat_att_dr           | Update            | Updated with the attending doctor, likely from cpi_transaction.doctor_code (after processing).                                                                                                                                                                                                                                                                                                                                                                                                                      |
| pat_adm_date         | Update            | Updated with the admission datetime from cpi_transaction.admission_datetime (after processing), if provided.                                                                                                                                                                                                                                                                                                                                                                                                        |
| pat_location         | Update            | Updated from cpi_transaction.ward_code if IPAS_BATCH_ADM. Otherwise, from convert_IPAS_to_LIS/copy_patient_demo. A hospital prefix might be added.                                                                                                                                                                                                                                                                                                                                                                  |
| pat_bed              | Update            | Updated from cpi_transaction.bed_no if IPAS_BATCH_ADM. For UCH "SOPD", might be re-derived from MRN. Otherwise, from convert_IPAS_to_LIS/copy_patient_demo.                                                                                                                                                                                                                                                                                                                                                         |
| pat_unit             | Update            | Updated from cpi_transaction.specialty_code if IPAS_BATCH_ADM. Otherwise, from convert_IPAS_to_LIS/copy_patient_demo. A hospital prefix might be added.                                                                                                                                                                                                                                                                                                                                                             |
| pat_cat              | Update            | Updated to the patient category determined by insert_patient_rec based on cpi_transaction.case_type or encounter prefix.                                                                                                                                                                                                                                                                                                                                                                                            |
| pat_risk             | No Change         | Not part of the SET clause.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| pat_create_date      | No Change         | Creation timestamp is not changed on update.                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| pat_create_by        | No Change         | Creator is not changed on update.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| pat_update_date      | Update            | Updated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                                                                                                                                                                                                                                                                                                                                                               |
| pat_update_by        | Update            | Updated with the LIS system user ID performing the update (from set_action_info()).                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| pat_create_ws        | No Change         | Creation workstation is not changed on update.                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| pat_update_ws        | Update            | Updated with the LIS system workstation ID (from set_action_info()).                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_address          | Update            | Updated with the patient's address from cpi_transaction address fields (after processing), if provided.                                                                                                                                                                                                                                                                                                                                                                                                             |
| pat_discharge_date   | No Change         | The insert_patient_rec update logic does not include pat_discharge_date in its SET clause. This would typically be handled by discharge_pat or similar functions.                                                                                                                                                                                                                                                                                                                                                   |
| pat_encounter_group  | Update            | Updated to the ENCOUNTER_GROUP C variable. If the encounter was existing, check_encounter would have populated this. If it was new to the system (but PID existed), get_set_ctr would generate it.                                                                                                                                                                                                                                                                                                                  |
| pat_pid_group        | Update            | Updated to the PID_GROUP C variable. check_pid would have populated this if the PID existed, or get_set_ctr if it was new.                                                                                                                                                                                                                                                                                                                                                                                          |
| pat_active_encounter | Update            | Updated to an indicator that the encounter is active (typically the value of pat_encounter_group or a non-zero value like 1, set by set_patient_ind() and used in insert_patient_rec).                                                                                                                                                                                                                                                                                                                              |
| pat_race             | Update            | Updated with the patient's race from cpi_transaction.race_code (after processing).                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| pat_mrn              | Update            | The insert_patient_rec update SQL has a separate preceding UPDATE patient SET pat_mrn = :pat_mrn WHERE pat_encounter = :pat_encounter AND pat_pid = :pat_pid AND pat_hospital = :cpi_hospital_code[rec_no]. So, MRN is updated based on the pat_mrn C variable (from cpi_transaction.medical_record_number) for the specific hospital in the incoming CPI transaction. The main update for other demographics then proceeds, and its SET clause for pat_mrn is commented out, relying on the prior specific update. |
| pat_cname            | Update            | Updated with the patient's Chinese name from cpi_transaction (after processing).                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| pat_death            | Update            | Updated based on cpi_transaction.death_indicator (after processing by set_patient_ind()), if provided.                                                                                                                                                                                                                                                                                                                                                                                                              |
| pat_death_date       | Update            | Updated with cpi_transaction.death_date if cpi_transaction.death_indicator is 'Y' (after processing), if provided.                                                                                                                                                                                                                                                                                                                                                                                                  |
| pat_hospital         | Update            | Value remains the same (part of WHERE and SET).                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| pat_exact_dob_flag   | Update            | Updated with the exact DOB flag from cpi_transaction.exact_dob_flag.                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_discharge_code   | No Change         | Not part of the SET clause in insert_patient_rec's update statement.                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_type             | Update            | Updated with the patient type from cpi_transaction.patient_type (after processing).                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| pat_ward_class       | Update            | Updated with the ward class from cpi_transaction.ward_class (after processing), if provided.                                                                                                                                                                                                                                                                                                                                                                                                                        |

---

## change_adm

This function is responsible for updating details of an existing patient admission. It first retrieves the current patient admission details. Then, based on the incoming data from the cpi_transaction record, it updates either just the admission date and patient type, OR it updates the location (ward, unit, bed) and ward class details along with the patient type.

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Update            | The existing LIS patient record for the specified encounter (from cpi_transaction.case_no), patient ID (from cpi_transaction.hkid), and hospital (from cpi_transaction.hospital_code) is updated. The specific columns updated depend on whether "old" location details (old_ward_code, old_specialty_code, old_bed_no, old_ward_class) were NULL or provided in the incoming cpi_transaction record. |
| pat_amend_log          | Insert            | An audit record (with a transaction type CHANGE_ADM) is inserted into pat_amend_log if the system is in DEBUG_MODE and the update to the patient table was successful. This is not a standard operational log for every change admission.                                                                                                                                                             |
| (System Counter Table) | No Change         | This function does not appear to directly call get_set_ctr to generate new sequence numbers. It modifies existing admission data.                                                                                                                                                                                                                                                                     |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated. The WHERE clause for the update targets the record matching pat_encounter = :ENCOUNTER (from cpi_transaction.case_no), pat_hospital = :HOSPITAL (from cpi_transaction.hospital_code), and pat_pid = :PID (from cpi_transaction.hkid).

There are two main UPDATE scenarios based on whether the cpi_transaction.old_ward_code, cpi_transaction.old_specialty_code, cpi_transaction.old_bed_no, and cpi_transaction.old_ward_class fields in the incoming transaction record were NULL. These fields in the cpi_transaction table are used to carry the previous location/ward class information when a change from those old values is intended.

Scenario 1: Only Admission Datetime and Patient Type are updated.

This occurs if cpi_transaction.old_ward_code, cpi_transaction.old_specialty_code, cpi_transaction.old_bed_no, AND cpi_transaction.old_ward_class fields were all NULL in the incoming transaction. This implies that only a change to the admission date and/or patient type is intended, not a location change.

| **Column Name** | **Insert/Update** | **Remarks**                                                                                                                         |
| --------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| pat_adm_date    | Update            | Updated with the admission datetime from the incoming cpi_transaction.admission_datetime.                                           |
| pat_type        | Update            | Updated with the patient type from the incoming cpi_transaction.patient_type (if cpi_transaction.patient_type itself was not NULL). |
| pat_update_date | Update            | Updated with the LIS system's current transaction timestamp.                                                                        |
| pat_update_by   | Update            | Updated with the LIS system user ID performing the update.                                                                          |
| pat_update_ws   | Update            | Updated with the LIS system workstation ID from which the update originated.                                                        |
| Other columns   | No Change         | Other columns like pat_location, pat_unit, pat_bed, pat_ward_class are NOT modified in this specific update SQL.                    |

Scenario 2: Location, Ward Class, and Patient Type are updated.

This occurs if at least one of cpi_transaction.old_ward_code, cpi_transaction.old_specialty_code, cpi_transaction.old_bed_no, or cpi_transaction.old_ward_class fields was not NULL in the incoming transaction. This suggests that "old" location/ward class values were supplied, and a change from these old values to new ones is intended.

| **Column Name** | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| --------------- | ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_location    | Update            | Updated with the new location. This is derived based on complex logic involving the incoming cpi_transaction.case_type and cpi_transaction.hospital_code: <br/> - If cpi_transaction.case_type is 'O' (Outpatient) and was not NULL: <br/> - If the cpi_transaction.hospital_code is not one of several specific hospital codes (AHN, BBH, CHS, NDH, PWH, SH, TPH), then pat_location is set from the first 4 characters of cpi_transaction.case_no. If the CLT system configuration is active, this location might be prefixed with '%'. <br/> - Otherwise (hospital is one of the listed specific codes), pat_location is set to "SOPD". <br/> - Else (not Outpatient, or cpi_transaction.case_type was NULL): pat_location is set from the incoming cpi_transaction.ward_code. <br/>The add_hospital_prefix() utility function might further modify this derived location value by prepending a hospital-specific prefix before the actual database update. |
| pat_unit        | Update            | Updated with the new unit from the incoming cpi_transaction.specialty_code. The add_hospital_prefix() utility function might further modify this value by prepending a hospital-specific prefix.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| pat_bed         | Update            | Updated with the new bed number from the incoming cpi_transaction.bed_no. <br/> - If the UCH system configuration is active and the LIS ENCOUNTER (which corresponds to cpi_transaction.case_no) is "SOPD", the bed number might be re-derived based on the cpi_transaction.medical_record_number (if provided) using the convert_mrn_to_bed() utility.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| pat_ward_class  | Update            | Updated with the new ward class from the incoming cpi_transaction.ward_class if cpi_transaction.ward_class itself was not NULL.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_type        | Update            | Updated with the patient type from the incoming cpi_transaction.patient_type (if cpi_transaction.patient_type itself was not NULL).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| pat_update_date | Update            | Updated with the LIS system's current transaction timestamp.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| pat_update_by   | Update            | Updated with the LIS system user ID performing the update.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| pat_update_ws   | Update            | Updated with the LIS system workstation ID from which the update originated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| pat_adm_date    | No Change         | The LIS pat_adm_date is NOT modified in this specific update SQL scenario (it's only updated in Scenario 1).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Other columns   | No Change         | Other demographic columns like pat_name, pat_dob, etc., are NOT modified by this change_adm function.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

Key Pre-computation/Logic before Update:

- The C variables pat_location, pat_unit, pat_bed, and pat_ward_class (which will be used in the SET clause of the SQL UPDATE) are prepared based on values from the incoming cpi_transaction record (such as case_type, hospital_code, ward_code, specialty_code, bed_no, ward_class) and existing system configurations (like CLT, UCH).
- The add_hospital_prefix() function might prepend a hospital-specific prefix to the C variables pat_location and pat_unit before they are used in the SQL update, depending on site configuration.
- For UCH "SOPD" encounters, the C variable pat_bed might be overridden by a value derived from the MRN (if available in the cpi_transaction).
- These prepared C variables are then used in the SET clause of the second UPDATE scenario.

---

## internal_transfer

This function is designed to update a patient's location details (ward, unit, bed) and ward class within the LIS, reflecting an internal transfer within the hospital or facility. It first fetches the existing patient record and then updates it with the new location information provided in the IPAS_rec structure, which is populated from the cpi_transaction record.

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                   |
| ---------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Update            | The existing LIS patient record for the specified encounter (from cpi_transaction.case_no), patient ID (from cpi_transaction.hkid), and hospital (from cpi_transaction.hospital_code) is updated with new location, bed, unit, and ward class details.                        |
| pat_amend_log          | Insert            | An audit record (with a transaction type INTERNAL_TRANSFER) is inserted into pat_amend_log if the update to the patient table was successful. This logs the "from" and "to" location details.                                                                                 |
| (System Counter Table) | No Change         | This function does not call get_set_ctr; it modifies existing admission data.                                                                                                                                                                                                 |
| request_copy_hist      | Update            | This table (or similar, related to remote request updates) was intended to be updated in older versions of the code (commented out section). The goal was to update request copy history for certain labs when a patient was transferred. This logic is currently not active. |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated. The WHERE clause for the update targets the record matching pat_encounter = :ENCOUNTER (from cpi_transaction.case_no), pat_hospital = :HOSPITAL (from cpi_transaction.hospital_code), and pat_pid = :PID (from cpi_transaction.hkid).

The actual update is performed by the transfer_patient_rec() function call (defined in lis_sp_laps_sql.cp).

| **Column Name** | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| pat_location    | Update            | Updated with the new location. <br/> - This is primarily taken from IPAS_rec.ward_cde (which itself is populated from cpi_transaction.ward_code or, in cancel_transfer scenarios, from cpi_transaction.old_ward_code).<br/> - If in_prog_id is IPAS_BATCH_ADJ AND cpi_transaction.case_type is 'O' (Outpatient and not NULL), then IPAS_rec.ward_cde (and thus pat_location) is specially set to the first 4 characters of IPAS_rec.case_no (i.e., cpi_transaction.case_no). If CLT is defined, this might be prefixed with '%'.<br/> - The add_hospital_prefix() utility might further modify this value before the SQL update by prepending a hospital-specific prefix. <br/> - If the prepared pat_location C variable becomes "HOME", the entire transaction is rolled back, and no update occurs. |
| pat_bed         | Update            | Updated with the new bed number, primarily from IPAS_rec.bed_no (which is from cpi_transaction.bed_no or cpi_transaction.old_bed_no in cancel_transfer cases).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| pat_unit        | Update            | Updated with the new unit, primarily from IPAS_rec.speciality (which is from cpi_transaction.specialty_code or cpi_transaction.old_specialty_code in cancel_transfer cases). The add_hospital_prefix() utility might further modify this value.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| pat_ward_class  | Update            | Updated with the new ward class, primarily from IPAS_rec.ward_class (which is from cpi_transaction.ward_class or cpi_transaction.old_ward_class in cancel_transfer cases). The null indicator ind_pat_ward_class is used.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| pat_update_date | Update            | Updated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| pat_update_by   | Update            | Updated with the LIS system user ID performing the update (from set_action_info()).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| pat_update_ws   | Update            | Updated with the LIS system workstation ID (from set_action_info()).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Other columns   | No Change         | Other columns like pat_name, pat_adm_date, pat_type, etc., are NOT modified by this internal_transfer function's primary SQL update (transfer_patient_rec).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

Key Pre-computation/Logic before Update:

- The C variables pat_location, pat_unit, pat_bed, and pat_ward_class are prepared.
- They are initially copied from the IPAS_rec structure. The IPAS_rec fields (ward_cde, speciality, bed_no, ward_class) are populated based on the cpi_transaction fields.
- Crucially, if the internal_transfer function is called as part of cancel_transfer, the IPAS_rec fields would have been populated by swapping the "current" and "old" location/ward values from the cpi_transaction record.
- A special condition exists: if in_prog_id is IPAS_BATCH_ADJ and the cpi_transaction.case_type is 'O' (Outpatient and not NULL), the IPAS_rec.ward_cde (which feeds pat_location) is set to the first 4 characters of the cpi_transaction.case_no.
- The add_hospital_prefix() function may prepend a hospital-specific prefix to the pat_location and pat_unit C variables before they are used in the transfer_patient_rec() SQL update.
- If, after all preparations, the pat_location C variable evaluates to "HOME", the function aborts the transfer, rolls back the transaction, and returns without updating the patient record.



---

## discharge_pat

This function is responsible for marking a patient as discharged in the LIS system. It retrieves the existing patient admission details and then updates the record with the discharge date and a discharge code (which is actually the transaction type of the discharge event).

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                    |
| ---------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Update            | The existing LIS patient record for the specified encounter (from cpi_transaction.case_no), patient ID (from cpi_transaction.hkid), and hospital (from cpi_transaction.hospital_code) is updated to set the discharge date and discharge code. |
| pat_amend_log          | Insert            | An audit record (with a transaction type DISCHARGE_PAT) is inserted into pat_amend_log if the system is in DEBUG_MODE and the update to the patient table was successful. This is not a standard operational log for every patient discharge.  |
| (System Counter Table) | No Change         | This function does not call get_set_ctr; it modifies existing admission data.                                                                                                                                                                  |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated. The WHERE clause for the update targets the record matching pat_encounter = :ENCOUNTER (from cpi_transaction.case_no), pat_hospital = :HOSPITAL (from cpi_transaction.hospital_code), and pat_pid = :PID (from cpi_transaction.hkid).

| **Column Name**    | **Insert/Update** | **Remarks**                                                                                                                                                                                    |
| ------------------ | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_discharge_date | Update            | Updated with the discharge datetime from the incoming cpi_transaction.discharge_datetime.                                                                                                      |
| pat_discharge_code | Update            | Updated with the transaction type of the discharge event from the incoming cpi_transaction.transaction_type. (Note: The column name is pat_discharge_code but it's set from transaction_type). |
| pat_update_date    | Update            | Updated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                                          |
| pat_update_by      | Update            | Updated with the LIS system user ID performing the update (from set_action_info()).                                                                                                            |
| pat_update_ws      | Update            | Updated with the LIS system workstation ID (from set_action_info()).                                                                                                                           |
| pat_bed            | No Change         | Although commented out in the SQL (/* pat_bed = NULL, */), the active code does not change the pat_bed. It remains as it was.                                                                  |
| Other columns      | No Change         | Other columns like pat_name, pat_adm_date, pat_location, etc., are NOT modified by this discharge_pat function.                                                                                |

Key Points for discharge_pat:

- The function first ensures the patient record exists using get_patient_details().
- The primary action is to set the pat_discharge_date and pat_discharge_code on the existing patient record.
- The patient's bed information (pat_bed) is explicitly not cleared or changed as part of this discharge SQL, even though a comment suggests it might have been considered in the past.

---

## cancel_adm

This function is used to cancel an existing patient admission. It first retrieves the patient's admission details and checks if there are any outstanding laboratory requests for that admission. If requests exist, the cancellation is aborted. Otherwise, it proceeds to mark the admission record as canceled by updating its encounter number to a special "cancellation" encounter name and deactivating it.

### General Table Insert/Update Summary

| **Table Name**                    | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| --------------------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                           | Update            | The existing LIS patient record for the specified encounter (from cpi_transaction.case_no), patient ID (from cpi_transaction.hkid), and hospital (from cpi_transaction.hospital_code) is updated to mark the admission as canceled. This involves changing the pat_encounter to a new system-generated "cancellation" encounter name, setting pat_pid_group to 0, and setting pat_active_encounter to 0. This operation is conditional on no existing laboratory requests being found for the patient's pat_pid_group and pat_encounter_group. |
| pat_amend_log                     | Insert            | An audit record (with a transaction type CANCEL_ADM) is inserted into pat_amend_log if the update to the patient table was successful. This log entry records the original encounter details and the new "cancellation" encounter name.                                                                                                                                                                                                                                                                                                        |
| (System Counter Table)            | Update            | Internal system counters (likely in a table like global_ctr) are updated via get_set_ctr to generate a new unique Cancellation Number (CANCEL_NO). This number is used to create the unique "cancellation" encounter name.                                                                                                                                                                                                                                                                                                                     |
| request (and related test tables) | Select (via SP)   | The function calls check_patient_request(), which executes a stored procedure (lis_sp_pat_chk_req_exist_all). This stored procedure checks for the existence of records in laboratory request tables (and potentially other test-specific tables) linked to the pat_pid_group and pat_encounter_group of the admission being canceled. If any requests are found, the cancellation is aborted.                                                                                                                                                 |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated by the cancel_patient_rec(0) function call. The WHERE clause for this update targets the LIS patient record matching pat_encounter = :ENCOUNTER (from cpi_transaction.case_no), pat_hospital = :HOSPITAL (from cpi_transaction.hospital_code), and pat_pid = :PID (from cpi_transaction.hkid).

| **Column Name**      | **Insert/Update** | **Remarks**                                                                                                                                                                              |
| -------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter        | Update            | Updated to a new, unique "cancellation" encounter name. This name is constructed using a standard prefix (e.g., CAN_ENC_HEAD) and the newly generated CANCEL_NO.                         |
| pat_pid_group        | Update            | Set to 0. This disassociates the canceled admission record from its patient identifier group.                                                                                            |
| pat_active_encounter | Update            | Set to 0. This marks the original admission encounter as inactive.                                                                                                                       |
| pat_update_date      | Update            | Updated with the LIS system's current transaction timestamp (populated into the C variable pat_update_date by set_action_info() before cancel_patient_rec is called).                    |
| pat_update_by        | Update            | Updated with the LIS system user ID performing the update (populated into the C variable pat_update_by by set_action_info()).                                                            |
| pat_update_ws        | Update            | Updated with the LIS system workstation ID (populated into the C variable pat_update_ws by set_action_info()).                                                                           |
| Other columns        | No Change         | Other columns of the LIS patient record (e.g., pat_name, pat_adm_date, pat_location, pat_discharge_date, etc.) are NOT modified by this specific cancel_patient_rec(0) update operation. |

Key Points for cancel_adm:

- The function first validates that the patient record exists and, critically, that no associated lab requests are present.
- A new unique cancellation encounter name is generated.
- The core action is to logically "cancel" the admission by renaming its encounter string and resetting its group and activity flags, rather than physically deleting the record.

---

## cancel_discharge

This function is used to reverse a patient's discharge status in the LIS system. It finds the patient's existing admission record and updates it by clearing the discharge date and setting a new discharge code (which is typically the transaction type of the "cancel discharge" event itself).

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                               |
| ---------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Update            | The existing LIS patient record for the specified encounter (from cpi_transaction.case_no), patient ID (from cpi_transaction.hkid), and hospital (from cpi_transaction.hospital_code) is updated. Specifically, the pat_discharge_date is set to NULL, and pat_discharge_code is updated. |
| pat_amend_log          | Insert            | An audit record (with a transaction type CANCEL_DISCHARGE) is inserted into pat_amend_log if the system is in DEBUG_MODE and the update to the patient table was successful. This is not a standard operational log for every cancel discharge operation.                                 |
| (System Counter Table) | No Change         | This function does not call get_set_ctr; it modifies existing admission data and does not require new sequence numbers for this operation.                                                                                                                                                |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated. The WHERE clause for the update targets the LIS patient record matching pat_encounter = :ENCOUNTER (from cpi_transaction.case_no), pat_hospital = :HOSPITAL (from cpi_transaction.hospital_code), and pat_pid = :PID (from cpi_transaction.hkid).

| **Column Name**    | **Insert/Update** | **Remarks**                                                                                                                                                                                                                               |
| ------------------ | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_discharge_date | Update            | Set to NULL. This effectively removes the previously recorded discharge date, indicating the patient is no longer considered discharged as of that date.                                                                                  |
| pat_discharge_code | Update            | Updated with the transaction type of the "cancel discharge" event itself, which is sourced from the incoming cpi_transaction.transaction_type. (Note: The column is pat_discharge_code, but it stores the event's transaction type here). |
| pat_update_date    | Update            | Updated with the LIS system's current transaction timestamp (obtained via set_action_info()).                                                                                                                                             |
| pat_update_by      | Update            | Updated with the LIS system user ID responsible for this update (obtained via set_action_info()).                                                                                                                                         |
| pat_update_ws      | Update            | Updated with the LIS system workstation ID from which this update originated (obtained via set_action_info()).                                                                                                                            |
| pat_bed            | No Change         | The SQL statement has a commented-out line /* pat_bed = :cpi_bed_no[rec_no], */. The active code does not change the pat_bed as part of this cancel discharge operation. It remains as it was.                                            |
| Other columns      | No Change         | Other columns of the LIS patient record (e.g., pat_name, pat_adm_date, pat_location, etc.) are NOT modified by this cancel_discharge function.                                                                                            |

Key Points for cancel_discharge:

- The function first retrieves the existing patient details to ensure the record to be updated exists.
- The core logic is to nullify the pat_discharge_date and update pat_discharge_code.
- It does not re-instate previous location details like bed number through this specific SQL, even if the patient is effectively no longer discharged. Any bed change would typically be handled by a separate transfer or admission update transaction.

---

## cancel_transfer

This function is designed to reverse or "cancel" a previous internal patient transfer. It achieves this by:

1. Swapping Location Data: It takes the "current" location details (ward, specialty, bed, ward class) and the "old" location details from the incoming cpi_transaction record and swaps them. This means the "old" location effectively becomes the "new" target location for the subsequent operation.
2. Calling internal_transfer: After swapping these details, it then calls the internal_transfer function. The internal_transfer function will then process the transfer as if the patient is being moved to what was previously their "old" location.

Therefore, the database operations performed by cancel_transfer are essentially the same as those performed by internal_transfer, but the target location, bed, unit, and ward class for the update will be the previous ones due to the swap.

There's a condition at the beginning: if the cpi_transaction.hospital_code is HHH, NLH, POH, TCN, TPH, or WTS, this swapping logic is skipped, and internal_transfer is called directly with the cpi_transaction data as is. For this analysis, we'll assume the hospital code does not match these, and the swap occurs.

### General Table Insert/Update Summary

(This will be the same as internal_transfer because cancel_transfer calls it after preparing the data.)

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                              |
| ---------------------- | ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Update            | The existing LIS patient record for the specified encounter (from cpi_transaction.case_no), patient ID (from cpi_transaction.hkid), and hospital (from cpi_transaction.hospital_code) is updated with new location, bed, unit, and ward class details. Due to the swap in cancel_transfer, these "new" details will actually be the patient's previous location details from the cpi_transaction record. |
| pat_amend_log          | Insert            | An audit record (with a transaction type INTERNAL_TRANSFER because internal_transfer is called) is inserted into pat_amend_log if the update to the patient table was successful. This logs the "from" and "to" location details (where "to" will be the patient's previous location).                                                                                                                   |
| (System Counter Table) | No Change         | internal_transfer (and thus cancel_transfer) does not call get_set_ctr; it modifies existing admission data.                                                                                                                                                                                                                                                                                             |
| request_copy_hist      | No Change         | The logic to update this table is commented out in the internal_transfer function, so no update occurs.                                                                                                                                                                                                                                                                                                  |

---

### Detailed patient Table Column Insert/Update Analysis

(This describes the update performed by transfer_patient_rec() which is called by internal_transfer. The key is that the C variables pat_location, pat_bed, pat_unit, and pat_ward_class will hold the swapped* (i.e., previous) location details when internal_transfer is called by cancel_transfer.)*

The LIS patient table is updated. The WHERE clause for the update targets the record matching pat_encounter = :ENCOUNTER (from cpi_transaction.case_no), pat_hospital = :HOSPITAL (from cpi_transaction.hospital_code), and pat_pid = :PID (from cpi_transaction.hkid).

| **Column Name** | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_location    | Update            | Updated to reflect the patient's previous ward. <br/> - The value comes from the C variable pat_location. In cancel_transfer, this variable is populated from IPAS_rec.ward_cde, which itself was set using the swapped data (i.e., cpi_transaction.old_ward_code becomes the new IPAS_rec.ward_cde).<br/> - The add_hospital_prefix() utility might further modify this value before the SQL update by prepending a hospital-specific prefix. <br/> - If the C variable pat_location (after potential modification by IPAS_BATCH_ADJ logic within internal_transfer if it were an outpatient case) evaluates to "HOME", the transaction is rolled back by internal_transfer, and no update occurs. |
| pat_bed         | Update            | Updated to reflect the patient's previous bed number. The value comes from IPAS_rec.bed_no, which was set using the swapped data (i.e., cpi_transaction.old_bed_no).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| pat_unit        | Update            | Updated to reflect the patient's previous unit/specialty. The value comes from IPAS_rec.speciality, which was set using the swapped data (i.e., cpi_transaction.old_specialty_code). The add_hospital_prefix() utility might further modify this value.                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| pat_ward_class  | Update            | Updated to reflect the patient's previous ward class. The value comes from IPAS_rec.ward_class, which was set using the swapped data (i.e., cpi_transaction.old_ward_class). The null indicator ind_pat_ward_class is used.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| pat_update_date | Update            | Updated with the LIS system's current transaction timestamp (this is set by set_action_info() within internal_transfer).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| pat_update_by   | Update            | Updated with the LIS system user ID performing the update (this is set by set_action_info() within internal_transfer).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| pat_update_ws   | Update            | Updated with the LIS system workstation ID (this is set by set_action_info() within internal_transfer).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| Other columns   | No Change         | Other columns like pat_name, pat_adm_date, pat_type, etc., are NOT modified by the transfer_patient_rec() SQL update called by internal_transfer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

Key Points for cancel_transfer:

- The core logic is the swapping of "current" and "old" location/ward class data from the cpi_transaction record before these values are passed (via the IPAS_rec struct) to the internal_transfer function.
- This swapping effectively makes the internal_transfer function move the patient back to their previous location.
- The actual database update is performed by the transfer_patient_rec function, which is called by internal_transfer.
- The pat_amend_log will record this as an INTERNAL_TRANSFER because that's the context within which write_amend_log is called by the internal_transfer function.
- The conditional skip of the swap for certain hospitals (HHH, NLH, POH, TCN, TPH, WTS) means that for these hospitals, cancel_transfer would behave identically to internal_transfer using the non-swapped cpi_transaction data.

---

## merge_pid

This function handles the scenario where two distinct patient identifiers (PIDs) in the LIS system are determined to belong to the same actual patient, and their records need to be merged under one target PID.

The process is:

1. It first establishes the PID_GROUP for the "source" PID (the one to be merged from, cpi_transaction.old_hkid).
2. It retrieves all encounters associated with this source PID_GROUP.
3. It then establishes the PID_GROUP for the "target" PID (the one to merge to, cpi_transaction.hkid). If this target PID doesn't exist (i.e., has no PID_GROUP), it diverts to the change_pid logic, as it's not a merge but a change to a new, non-existent PID.
4. For each encounter found under the source PID:
- If the encounter is already a "cancellation" type encounter, it simply updates its pat_pid_group to the target PID_GROUP.
- If it's a normal active encounter, it "cancels" this encounter (renames it, deactivates it, and clears its original pat_pid_group) and then creates a new patient record for this same encounter but now associated with the target PID and target PID_GROUP.
5. Finally, it updates related tables (like request) to point from the source PID_GROUP to the target PID_GROUP.

### General Table Insert/Update Summary

| **Table Name**                    | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------------------------- | ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                           | Update            | For LIS patient encounters under the "source" PID (cpi_transaction.old_hkid) that are already "cancellation" type encounters (their pat_encounter string starts with CAN_ENC_HEAD), only their pat_pid_group is updated to the PID_GROUP of the "target" PID (cpi_transaction.hkid). Update timestamps are also set.                                                                                                                                                                                                                                                                                                                                                                   |
| patient                           | Update            | For each active LIS patient encounter associated with the "source" PID (cpi_transaction.old_hkid), its existing record in the LIS patient table is updated to mark it as "canceled." This involves changing its pat_encounter to a new system-generated "cancellation" encounter name, setting its pat_active_encounter to 0 (inactive), and setting its pat_pid_group to 0.                                                                                                                                                                                                                                                                                                           |
| patient                           | Insert            | For each active LIS patient encounter that was "canceled" from the "source" PID, a new patient record is inserted into the LIS patient table. This new record uses the original encounter number but is now associated with the target patient identifier (from cpi_transaction.hkid) and the PID_GROUP of this target PID. Most other details from the original LIS encounter are carried over.                                                                                                                                                                                                                                                                                       |
| pat_amend_log                     | Insert            | An audit record (with a transaction type MERGE_PID) is inserted into pat_amend_log for each LIS patient encounter that is effectively moved from the source PID to the target PID. This log entry details the source and target PIDs, encounter information, and PID groups.                                                                                                                                                                                                                                                                                                                                                                                                           |
| pid_check                         | Update/Insert     | After a normal encounter is moved to the target PID (via the cancel & insert mechanism), records in the pid_check table are updated or inserted. This links the original encounter group (ENCOUNTER_GROUP) to the new target PID_GROUP and also updates/inserts a record for the SOURCE_PID_GROUP to reflect the change (this is done via the update_pid_check(CHANGE_PID) call where CHANGE_PID action code is used, which implies it might be logging both the source and target group changes for the same encounter group). The parameter passed to update_pid_check is CHANGE_PID, not MERGE_PID, which seems like a slight inconsistency but points to the underlying mechanism. |
| (System Counter Table)            | Update            | Internal system counters (likely in global_ctr) are updated via get_set_ctr to generate a new unique Cancellation Number (CANCEL_NO) for each active LIS encounter from the source PID that is being "canceled" and re-created under the target PID.                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| request (and related test tables) | Update            | For existing laboratory requests (and potentially records in other test-specific tables) linked to the SOURCE_PID_GROUP (of the cpi_transaction.old_hkid), their req_pid_group (or equivalent column) is updated to the target PID_GROUP (of cpi_transaction.hkid). This ensures these requests remain associated with the correct (merged) patient demographic master. This update is attempted with a retry mechanism via update_pid_group(MERGE_CASE).                                                                                                                                                                                                                              |
| lis_patient                       | Update            | If in_type == MERGE_PID (which is true here), the update_pid_group function (from lis_sp_laps_utility.cp) will update lis_patient.lispat_pid_group from SOURCE_PID_GROUP to the target PID_GROUP. This appears to be a separate, potentially summarized, patient table or view used by other systems (like a Central Record System - CRS).                                                                                                                                                                                                                                                                                                                                             |

---

### Detailed patient Table Column Insert/Update Analysis

The process iterates through all encounters (get_all_enc()) linked to the SOURCE_PID_GROUP (of cpi_transaction.old_hkid).

Scenario 1: Encounter is already a "Cancellation" type encounter

This applies if ENCOUNTER (from ENCOUNTERS[i-1]) starts with CAN_ENC_HEAD (e.g., "CAN%").

| **Column Name**       | **Insert/Update** | **Remarks**                                                                                                                                                                                                      |
| --------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_pid_group         | Update            | The LIS pat_pid_group of this already canceled record is updated to the target PID_GROUP (associated with cpi_transaction.hkid). This re-links the historical canceled encounter to the merged patient identity. |
| pat_update_date       | Update            | The LIS pat_update_date column is updated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                          |
| pat_update_by         | Update            | The LIS pat_update_by column is updated with the LIS system user ID responsible for this update (from set_action_info()).                                                                                        |
| pat_update_ws         | Update            | The LIS pat_update_ws column is updated with the LIS system workstation from which this update was performed (from set_action_info()).                                                                           |
| Other patient columns | No Change         | Other columns of this already canceled record are not modified by this specific update.                                                                                                                          |

Scenario 2: Encounter is an active/normal LIS encounter

This involves two steps for each such encounter: an UPDATE to "cancel" it from the source PID, then an INSERT to re-create it under the target PID.

2a. UPDATE (Canceling the existing LIS patient record from the source PID)

This is performed by cancel_patient_rec(0). Targets the LIS patient record identified by its original pat_encounter, pat_hospital, and the source pat_pid.

| **Column Name**       | **Insert/Update** | **Remarks**                                                                                                                                                  |
| --------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| pat_encounter         | Update            | The LIS pat_encounter identifier is changed to a new, unique "cancellation" encounter name (constructed using CAN_ENC_HEAD and a newly generated CANCEL_NO). |
| pat_pid_group         | Update            | The LIS pat_pid_group is set to 0.                                                                                                                           |
| pat_active_encounter  | Update            | The LIS pat_active_encounter flag is set to 0.                                                                                                               |
| pat_update_date       | Update            | Updated with the LIS system's current transaction timestamp.                                                                                                 |
| pat_update_by         | Update            | Updated with the LIS system user ID.                                                                                                                         |
| pat_update_ws         | Update            | Updated with the LIS system workstation ID.                                                                                                                  |
| Other patient columns | No Change         | Remaining columns are not modified by this specific "cancel" update.                                                                                         |

2b. INSERT (Creating a new LIS patient record under the target PID)

This is performed by insert_patient_rec(0). Values are sourced from the original LIS encounter details (fetched by get_patient_details()) and the target PID information.

| **Column Name**      | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                 |
| -------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_encounter        | Insert            | The original LIS pat_encounter number is used.                                                                                                                                                                                              |
| pat_pid              | Insert            | The target patient identifier from cpi_transaction.hkid is used.                                                                                                                                                                            |
| pat_name             | Insert            | Original pat_name from the fetched LIS encounter.                                                                                                                                                                                           |
| pat_sex              | Insert            | Original pat_sex from the fetched LIS encounter.                                                                                                                                                                                            |
| pat_dob              | Insert            | Original pat_dob (and null indicator) from the fetched LIS encounter.                                                                                                                                                                       |
| pat_age              | Insert            | Not explicitly set by insert_patient_rec() SQL.                                                                                                                                                                                             |
| pat_age_unit         | Insert            | Not explicitly set by insert_patient_rec() SQL.                                                                                                                                                                                             |
| pat_att_dr           | Insert            | Original pat_att_dr from the fetched LIS encounter.                                                                                                                                                                                         |
| pat_adm_date         | Insert            | Original pat_adm_date (and null indicator) from the fetched LIS encounter.                                                                                                                                                                  |
| pat_location         | Insert            | Original pat_location from the fetched LIS encounter. (Hospital prefix logic in insert_patient_rec might apply based on transaction type/site config).                                                                                      |
| pat_bed              | Insert            | Original pat_bed. (UCH "SOPD" MRN-to-bed logic in insert_patient_rec might apply if cpi_transaction.medical_record_number is available and conditions met).                                                                                 |
| pat_unit             | Insert            | Original pat_unit. (Hospital prefix logic in insert_patient_rec might apply).                                                                                                                                                               |
| pat_cat              | Insert            | Determined by insert_patient_rec based on cpi_transaction.case_type or original pat_encounter prefix.                                                                                                                                       |
| pat_risk             | Insert            | Not explicitly set by insert_patient_rec() SQL.                                                                                                                                                                                             |
| pat_create_date      | Insert            | Current LIS transaction timestamp.                                                                                                                                                                                                          |
| pat_create_by        | Insert            | Current LIS transaction user ID.                                                                                                                                                                                                            |
| pat_update_date      | Insert            | Current LIS transaction timestamp.                                                                                                                                                                                                          |
| pat_update_by        | Insert            | Current LIS transaction user ID.                                                                                                                                                                                                            |
| pat_create_ws        | Insert            | Current LIS transaction workstation ID.                                                                                                                                                                                                     |
| pat_update_ws        | Insert            | Current LIS transaction workstation ID.                                                                                                                                                                                                     |
| pat_address          | Insert            | Original pat_address (and null indicator).                                                                                                                                                                                                  |
| pat_discharge_date   | Insert            | Original pat_discharge_date (and null indicator).                                                                                                                                                                                           |
| pat_encounter_group  | Insert            | Original pat_encounter_group (from C variable ENCOUNTER_GROUP).                                                                                                                                                                             |
| pat_pid_group        | Insert            | The PID_GROUP of the target PID (from cpi_transaction.hkid, stored in C variable PID_GROUP).                                                                                                                                                |
| pat_active_encounter | Insert            | Original pat_active_encounter status.                                                                                                                                                                                                       |
| pat_race             | Insert            | Original pat_race.                                                                                                                                                                                                                          |
| pat_mrn              | Insert            | Original pat_mrn (and null indicator). (Logic regarding cpi_transaction.medical_record_number mentioned in change_pid comments might have nuances here if data was previously copied into C pat_mrn).                                       |
| pat_cname            | Insert            | Original pat_cname.                                                                                                                                                                                                                         |
| pat_death            | Insert            | Original pat_death status (and null indicator).                                                                                                                                                                                             |
| pat_confidential     | Insert            | Original pat_confidential status (and null indicator).                                                                                                                                                                                      |
| pat_death_date       | Insert            | Original pat_death_date (and null indicator).                                                                                                                                                                                               |
| pat_hospital         | Insert            | Original pat_hospital.                                                                                                                                                                                                                      |
| pat_exact_dob_flag   | Insert            | Value from cpi_transaction.exact_dob_flag (of the current merge transaction).                                                                                                                                                               |
| pat_discharge_code   | Insert            | Original pat_discharge_code (and null indicator).                                                                                                                                                                                           |
| pat_type             | Insert            | Original pat_type (and null indicator) as fetched by get_patient_details. The set_patient_ind() call, which would update this C variable from the current cpi_transaction.patient_type, is commented out in merge_pid prior to this insert. |
| pat_ward_class       | Insert            | Original pat_ward_class (and null indicator).                                                                                                                                                                                               |

---

## set_pat_death

This function is responsible for updating the death status and death date for a patient across all their active LIS encounters, provided certain demographic checks pass. It iterates through each active encounter for a given Patient ID (from cpi_transaction.hkid). For an encounter to be updated, it must pass a demographic verification (check_patient_demo_ex) against key demographic data from the incoming cpi_transaction.

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| patient                | Update            | For each active LIS encounter associated with the patient ID from cpi_transaction.hkid: if the encounter passes a demographic check against cpi_transaction.patient_name, cpi_transaction.sex, and cpi_transaction.dob (via check_patient_demo_ex), then the LIS patient record for that encounter and matching the cpi_transaction.hospital_code is updated. The update sets the pat_death status and pat_death_date.                                                                                                                                          |
| pat_amend_log          | Insert            | An audit record is inserted into pat_amend_log if the system is in DEBUG_MODE. The action code used for this log entry is DISCHARGE_PAT, which is a general code often used for record finalization events in this module, even though this specific function handles death updates. This insertion occurs after all encounters have been processed and the main transaction is committed.                                                                                                                                                                      |
| patient_pmi_ex         | Insert or Update  | This table is not directly updated by set_pat_death itself, but by the check_patient_demo_ex function it calls. If check_patient_demo_ex finds a mismatch between the LIS patient demographics and the key demographics in the cpi_transaction for a specific encounter, and that LIS record was not created/updated by an automated IPAS/PMI process, an exception record in patient_pmi_ex is either inserted (if no open exception exists for that encounter group) or updated (if an open exception already exists). This logs the demographic discrepancy. |
| (System Counter Table) | No Change         | This function does not call get_set_ctr; it modifies existing data and does not require new sequence numbers.                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated within a loop that iterates through all active encounters (ENCOUNTERS[i]) associated with the PID from cpi_transaction.hkid.

The WHERE clause for each UPDATE statement targets:

pat_encounter = :ENCOUNTERS[i] (the specific active encounter for the PID from the loop)

AND pat_hospital = :HOSPITAL (where :HOSPITAL is the C variable set from cpi_transaction.hospital_code at the beginning of set_pat_death)

AND pat_pid = :PID (where :PID is the C variable set from cpi_transaction.hkid at the beginning of set_pat_death).

This means an update will only occur for an active encounter of the given PID if that encounter also happens to be registered under the specific hospital code provided in the input cpi_transaction.

The C host variables :pat_update_date, :pat_update_by, and :pat_update_ws used in the SQL SET clause are assumed to be populated by the calling environment or a higher-level transaction wrapper for the entire cpi_transaction processing, as set_action_info() is commented out within set_pat_death.

| **Column Name** | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                     |
| --------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| pat_death_date  | Update            | If cpi_transaction.death_indicator is 'Y' AND cpi_transaction.death_date is not NULL: Updated with the death date from cpi_transaction.death_date. <br/>- If cpi_transaction.death_indicator is 'Y' AND cpi_transaction.death_date is NULL: Updated to NULL. <br/>- If cpi_transaction.death_indicator is 'N': Updated to NULL. |
| pat_death       | Update            | If cpi_transaction.death_indicator is 'Y': Updated to 'Y'. <br/>- If cpi_transaction.death_indicator is 'N': Updated to 'N'.                                                                                                                                                                                                    |
| pat_update_date | Update            | Updated with the LIS system's transaction timestamp associated with the processing of the current cpi_transaction.                                                                                                                                                                                                              |
| pat_update_by   | Update            | Updated with the LIS system user ID associated with the processing of the current cpi_transaction.                                                                                                                                                                                                                              |
| pat_update_ws   | Update            | Updated with the LIS system workstation ID associated with the processing of the current cpi_transaction.                                                                                                                                                                                                                       |
| Other columns   | No Change         | Other columns of the LIS patient record (e.g., pat_name, pat_adm_date, pat_location, etc.) are NOT modified by this set_pat_death function's SQL updates.                                                                                                                                                                       |

Key Points for set_pat_death:

- The function aims to update the death status across multiple encounters for a patient.
- Each encounter undergoes a demographic validation (check_patient_demo_ex) using the cpi_key_demo (containing PID, Name, Sex, DOB from the cpi_transaction) against the LIS data for that specific encounter (ENCOUNTERS[i] in its actual hospital HOSPITALS[i]). If this check fails (e.g., name mismatch for a manually created record), that encounter is skipped for the death update, and an exception might be logged in patient_pmi_ex.
- The actual UPDATE to the patient table for the death status is targeted using the encounter ID from the loop, the PID from the input cpi_transaction, and the hospital code also from the input cpi_transaction. This implies that if a patient has active encounters in multiple hospitals, only those encounters that are both for the given PID and are registered under the specific hospital mentioned in the cpi_transaction that triggered the death update will have their death status updated by this function.

---

## set_pat_confid

This function is responsible for setting or clearing the confidentiality status for a patient across all their active LIS encounters. Similar to set_pat_death, it iterates through each active encounter for a given Patient ID (from cpi_transaction.hkid). For an encounter's confidentiality status to be updated, it must pass a demographic verification (check_patient_demo_ex) against key demographic data from the incoming cpi_transaction. The actual confidentiality status ('Y' or 'N') is determined by the cpi_transaction.pmi_access_code.

### General Table Insert/Update Summary

| **Table Name**         | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| patient                | Update            | For each active LIS encounter associated with the patient ID from cpi_transaction.hkid: if the encounter passes a demographic check against cpi_transaction.patient_name, cpi_transaction.sex, and cpi_transaction.dob (via check_patient_demo_ex using the encounter's specific hospital), then the LIS patient record for that specific encounter (ENCOUNTERS[i] in its hospital HOSPITALS[i]) and matching the patient ID (PID from cpi_transaction.hkid) is updated. The pat_confidential column is set to 'Y' or 'N' based on the incoming cpi_transaction.pmi_access_code.           |
| pat_amend_log          | Insert            | An audit record is inserted into pat_amend_log if the system is in DEBUG_MODE. The action code used for this log entry is DISCHARGE_PAT, which appears to be a general-purpose code in this module for various record finalization or status change events, rather than one specific to confidentiality. This insertion occurs after all encounters have been processed and the main transaction is committed.                                                                                                                                                                             |
| patient_pmi_ex         | Insert or Update  | This table is not directly updated by set_pat_confid itself, but by the check_patient_demo_ex function it calls for each active encounter. If check_patient_demo_ex finds a mismatch between the LIS patient demographics for a specific encounter and the key demographics in the cpi_transaction, and that LIS record was not created/updated by an automated IPAS/PMI process, an exception record in patient_pmi_ex is either inserted (if no open exception exists for that encounter group) or updated (if an open exception already exists). This logs the demographic discrepancy. |
| (System Counter Table) | No Change         | This function does not call get_set_ctr; it modifies existing data and does not require new sequence numbers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |

---

### Detailed patient Table Column Insert/Update Analysis

The LIS patient table is updated within a loop that iterates through all active encounters (ENCOUNTERS[i]) associated with the PID (from cpi_transaction.hkid).

The WHERE clause for each UPDATE statement targets:

pat_encounter = :ENCOUNTERS[i] (the specific active encounter for the PID from the loop)

AND pat_hospital = :HOSPITALS[i] (the actual hospital where this specific LIS encounter ENCOUNTERS[i] is registered)

AND pat_pid = :PID (where :PID is the C variable set from cpi_transaction.hkid at the beginning of set_pat_confid).

The C host variables :pat_update_date, :pat_update_by, and :pat_update_ws used in the SQL SET clause are populated by set_action_info() at the beginning of the function.

| **Column Name**  | **Insert/Update** | **Remarks**                                                                                                                                                                                                                                |
| ---------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| pat_confidential | Update            | Updated to 'Y' (Yes) if the least significant bit of cpi_transaction.pmi_access_code is 0 (i.e., (cpi_pmi_access_code[rec_no] & 1) == 0). <br/>- Updated to 'N' (No) if the least significant bit of cpi_transaction.pmi_access_code is 1. |
| pat_update_date  | Update            | Updated with the LIS system's current transaction timestamp (from set_action_info()).                                                                                                                                                      |
| pat_update_by    | Update            | Updated with the LIS system user ID performing the update (from set_action_info()).                                                                                                                                                        |
| pat_update_ws    | Update            | Updated with the LIS system workstation ID from which the update originated (from set_action_info()).                                                                                                                                      |
| Other columns    | No Change         | Other columns of the LIS patient record (e.g., pat_name, pat_adm_date, pat_location, pat_death, etc.) are NOT modified by this set_pat_confid function's SQL updates.                                                                      |

Key Points for set_pat_confid:

- The function's goal is to synchronize the confidentiality status across all active encounters of a patient based on a central pmi_access_code.
- Demographic Verification per Encounter: Before updating an encounter, check_patient_demo_ex is called. This function compares the key demographics (PID, Name, Sex, DOB) stored in LIS for that specific encounter (using ENCOUNTERS[i] and its actual hospital HOSPITALS[i]) against the key demographics provided in the cpi_key_demo (which comes from the current cpi_transaction). If this check fails (e.g., name mismatch for a manually created record), that particular encounter is skipped for the confidentiality update, and an exception might be logged in patient_pmi_ex.
- Targeting the Update: The UPDATE statement for pat_confidential targets the specific LIS encounter (ENCOUNTERS[i]) in its actual registered hospital (HOSPITALS[i]) for the given patient ID (PID). This is different from set_pat_death where the hospital in the WHERE clause was fixed to the hospital from the cpi_transaction. Here, it correctly updates each encounter in its respective hospital.
- The confidentiality flag is determined by a bitwise operation on the cpi_transaction.pmi_access_code.

